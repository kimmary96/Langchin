# 어디가 아프니? 🤱

![Python](https://img.shields.io/badge/Python-3.10+-3776AB?logo=python&logoColor=white)
![Streamlit](https://img.shields.io/badge/Streamlit-1.x-FF4B4B?logo=streamlit&logoColor=white)
![LangChain](https://img.shields.io/badge/LangChain-0.x-1C3C3C?logo=langchain&logoColor=white)
![OpenAI](https://img.shields.io/badge/OpenAI-GPT--4o-412991?logo=openai&logoColor=white)
![License](https://img.shields.io/badge/License-MIT-green)

---

## 1. 서비스 개요

| 항목 | 내용 |
|------|------|
| **서비스명** | 어디가 아프니? |
| **한 줄 정의** | 내 병력을 다 알고 있는 엄마 같은 친구가 아플 때 곁에서 위로해주고 건강을 함께 관리해주는 AI 챗봇 |
| **핵심 가치** | 아플 때 혼자가 아닌 느낌 — 심리적 위로 + 실질적 건강 정보 제공 |
| **핵심 흐름** | 공감 → 증상 파악 → 진료과 안내 → 건강 기록 |

---

## 2. 문제 정의

| 문제 상황 | 설명 |
|-----------|------|
| **감정적 외로움** | 아프다고 말해도 공감받지 못하는 서운함 |
| **반복 증상 피로** | 매번 같은 걱정을 주변에 털어놓기 미안함 |
| **정보 파편화** | 내 병력을 모르는 챗봇에게 매번 처음부터 설명해야 하는 번거로움 |
| **건강 기록 부재** | 언제 어떻게 아팠는지 기록이 없어 병원 갈 때 설명이 어려움 |

---

## 3. 타겟 사용자

**주요 타겟**: 만성 질환이나 반복 증상을 가진 30~50대 여성

| 사용자 특성 | 내용 |
|-------------|------|
| 상황 | 자주 아프지만 바쁜 가족에게 매번 말하기 미안한 사람 |
| 니즈 | 판단 없이 들어주고 공감해주는 존재 |
| 행동 패턴 | 모바일로 틈틈이 기록, 아플 때 즉각적으로 도움 요청 |
| 페인포인트 | 내 상황을 매번 새로 설명해야 하는 피로감 |

---

## 4. 페르소나

**이름**: 어디가 아프니? (엄마품)

### 페르소나 원칙

| 원칙 | 설명 |
|------|------|
| **무조건적인 공감** | 판단하거나 가르치려 들지 않고, 아픔에 가장 먼저 깊이 공감 |
| **자연스러운 친밀감** | 반말과 친근한 어미(~해, ~야, ~지, ~거든)로 든든한 내 편 같은 느낌 |
| **상황적 위로** | 증상 때문에 오늘 하루 일상이나 업무가 얼마나 고단할지 헤아려 위로 (단, 직업/상황을 모를 때는 섣불리 넘겨짚지 않고 증상 자체의 보편적 불편함에 공감) |
| **간결한 소통** | 아픈 사람은 긴 글을 읽기 힘드므로, 핵심만 담아 최대 3문장 이내 |

### 말투 예시

- "아구, 배 아파서 화장실 계속가면 밥도 잘 못먹고 기운이 없겠네." (O)
- "어머, 머리 아프면 계속 신경 쓰이겠다 어째 ㅠㅠ" (O)
- "조용한 곳에서 잠깐 눈 좀 붙여보는 건 어때?" (O)
- "자세를 한번 바꿔봐." (O — 자연스러운 제안)
- "목을 헹궈보는 건 어떤지 해봐" (X — 어색한 번역투 문법 절대 금지)

### 페르소나 설정 이유

자주 아픈 사람이 가장 힘든 건 신체 증상만이 아니라 _"또 아프다고 하면 귀찮아하겠지"_ 라는 심리적 부담감입니다. 엄마는 아무리 자주 아파도 귀찮아하지 않고 매번 걱정해주는 유일한 존재입니다. 이 심리적 안전감이 서비스의 핵심 차별점입니다.

---

## 5. 핵심 기능

### 5-1. 기능 현황

| 우선순위 | 기능 | 설명 | 상태 |
|----------|------|------|------|
| P0 | 🤱 엄마 페르소나 챗봇 | LangChain 기반 위로/공감/건강 조언 | ✅ |
| P0 | 🏥 병력 등록 및 기억 | 사이드바 등록 + 시스템 프롬프트 자동 반영 | ✅ |
| P1 | 📅 건강일기 캘린더 | 날짜별 7개 카테고리 기록 및 조회 | ✅ |
| P1 | 📷 약봉투 사진 분석 | 이미지 업로드 후 약 정보/상처 분석 안내 | ✅ |
| P2 | 💊 증상 기반 병원 추천 | 진료과 안내 + 네이버 지도 링크 | ✅ |
| P3 | ⏰ 약 복용 알림 | UI만 구현, 실제 알림 미작동 | 🚧 |

### 5-2. 기능 상세

#### 기능 1: 엄마 페르소나 챗봇 (P0)

- **LangChain ChatOpenAI + SystemMessage**로 엄마 페르소나 부여
- 당일 대화는 전체 유지, 날짜가 바뀌면 `chat_YYYY-MM-DD.json`에 자동 저장
- 등록된 병력 + 오늘의 건강일기를 시스템 프롬프트에 자동 포함
- 증상 키워드 감지 시 진료과 매핑 및 병원 방문 안내
- 시간대별(아침/점심/저녁) 다른 첫 인사 메시지

#### 기능 2: 병력 등록 및 관리 (P0)

- 사이드바 내 병력관리 메뉴
- 입력 항목: 질환명, 시기(YYYY-MM), 메모
- `data/medical_history.json`으로 로컬 저장
- 등록된 병력은 SystemMessage 프롬프트에 자동 반영
- 항목별 개별 삭제 가능

#### 기능 3: 건강일기 캘린더 (P1)

7개 카테고리를 아이콘 선택(pills) 방식으로 간편 입력:

| 카테고리 | 내용 |
|----------|------|
| 컨디션 | 😄 매우 좋음 ~ 😫 매우 나쁨 (5단계) |
| 증상 | 두통, 구역감, 복통, 발열, 피로, 콧물/기침, 근육통, 어지러움 |
| 배변 | 건강함, 설사, 초록똥, 변비 |
| 수면 | 0~12시간 슬라이더 (0.5h 단위) |
| 운동 | 걷기, 달리기, 실내자전거, 스트레칭/요가, 근력운동 |
| 병원 방문 | 주사/피검사/약 처방/입원 |
| 메모 | 자유 텍스트 |

- 📅 플로팅 버튼 클릭 시 캘린더 다이얼로그 표시
- 기록이 있는 날짜는 📝 표시 및 초록색 하이라이트
- 조회/편집/삭제 모드 지원

#### 기능 4: 약봉투 사진 분석 (P1)

- **OpenAI Vision API (GPT-4o)** 사용
- 📷 플로팅 버튼 클릭 시 이미지 업로드 다이얼로그 표시
- 분석 대상: 약봉투/포장지, 피부 이상, 멍/상처/화상
- 약 정보(효능, 부작용, 복용법)를 엄마 말투로 자연스럽게 전달
- 의학적 진단 없이 묘사 + 심각 시 병원 권유

#### 기능 5: 증상 기반 병원 추천 (P2)

- 60개 이상의 증상 키워드 → 진료과 자동 매핑
  - 내과, 산부인과, 정형외과, 이비인후과, 피부과, 치과, 안과, 정신건강의학과, 비뇨의학과, 가정의학과, 외과
- 여성 특화 질환(생리통, 질염, 갱년기 등) 별도 매핑
- 현재 메시지에 증상이 없으면 대화 이력에서 최근 증상 탐색
- 3가지 분기 처리:
  1. **병원 요청 + 진료과 파악됨** → AI는 다정한 병원 권유 멘트만 작성, 시스템이 네이버 지도 버튼을 HTML로 자동 삽입
  2. **병원 요청 + 진료과 미파악** → AI가 어디가 불편한지 다정하게 질문
  3. **증상만 있고 병원 요청 없음** → AI에게 진료과 정보를 참고용으로 제공, 자연스럽게 병원 방문 제안

#### 기능 6: 약 복용 알림 (P3)

- UI 구현: 약 이름, 복용 시간(아침/점심/저녁), 메모 입력 폼
- 등록된 알림 목록 표시 및 삭제
- 세션 내 동작만 가능 (영속 저장 및 실제 알림 발송 미구현)

---

## 6. 화면 구성

### 전체 화면 구조

```
메인 화면
├── 사이드바 (☰ 햄버거 메뉴)
│   ├── 🏥 내 병력 관리
│   ├── ⏰ 복약 알림 설정
│   └── ⚠️ 데모 초기화
├── 메인 채팅 영역
│   ├── 상단: 웰컴 타이틀 ("어디가 아프니?" / "엄마 품으로 오렴 💚")
│   ├── 중앙: 대화 버블 (엄마=초록, 나=노랑)
│   └── 하단: 입력창 ("어디가 아프니? 말해봐~")
├── 📅 캘린더 플로팅 버튼 (우측 상단)
│   └── 건강일기 다이얼로그 (날짜 선택 → 기록 조회/편집)
└── 📷 사진 플로팅 버튼 (우측 하단)
    └── 이미지 업로드 다이얼로그 (촬영/갤러리 → 분석)
```

### 주요 화면 설명

| 영역 | 설명 |
|------|------|
| 메인 채팅 | 모바일 390px 중앙 정렬, 아이보리 배경 |
| 채팅 버블 | 🤱 엄마품 라벨 + 초록 말풍선 (좌) / 노랑 말풍선 (우) |
| 플로팅 버튼 | 📅 캘린더 (우상단) · 📷 사진 (우하단) — 52px 원형 버튼 |
| 사이드바 | 병력 관리 폼 / 복약 알림 폼 / 2단계 확인 초기화 |

---

## 7. UI 디자인

| 항목 | 값 |
|------|-----|
| 레이아웃 | 모바일 세로 390px 중앙 정렬 |
| 배경 | 아이보리 화이트 (`#FFFFF0`) |
| 엄마 말풍선 | 연한 초록 (`#E8F5E9`) + 좌측 정렬 |
| 내 말풍선 | 따뜻한 노랑 (`#FFF9C4`) + 우측 정렬 |
| 액센트 컬러 | 연두 (`#8BC34A`) — 병원 링크 버튼, 웰컴 타이틀 |
| 전체 톤 | 병원처럼 차갑지 않고 집처럼 따뜻한 느낌 |

---

## 8. 기술 스택

| 영역 | 기술 | 선택 이유 |
|------|------|-----------|
| 프레임워크 | Streamlit | 빠른 프로토타이핑, Python 친화적 |
| AI 프레임워크 | LangChain | 메시지 체인 구조, 프롬프트 관리 용이 |
| 일반 대화 모델 | GPT-4o-mini | 비용 효율적, 일반 대화에 충분 |
| 이미지 분석 모델 | GPT-4o | Vision 기능은 더 강력한 모델 필요 |
| 데이터 저장 | JSON 파일 | 간단한 로컬 저장, 별도 DB 불필요 |
| 환경변수 관리 | python-dotenv | API 키 보안 관리 |

---

## 9. 프로젝트 구조

```
Langchin/
├── app.py                    # Streamlit 메인 진입점, UI 렌더링
├── chatbot.py                # MomChatbot 클래스, 증상→진료과 매핑, LangChain 체인
├── prompts.py                # 시스템 프롬프트 생성 (페르소나 + 병력 주입)
├── data_manager.py           # JSON 파일 CRUD (병력, 건강일기, 채팅)
├── vision.py                 # OpenAI Vision API 이미지 분석
├── components/
│   ├── __init__.py           # 모듈 초기화
│   ├── sidebar.py            # 병력 관리 + 복약 알림 + 전체 초기화 사이드바
│   ├── alarm_ui.py           # 복약 알림 UI (WIP)
│   └── calendar_view.py      # 건강일기 캘린더 다이얼로그
├── data/                     # 로컬 데이터 저장소 (자동 생성, gitignore)
│   ├── medical_history.json  # 병력 데이터
│   ├── health_diary.json     # 건강일기 (날짜별)
│   └── chat_YYYY-MM-DD.json  # 일별 대화 히스토리
├── .streamlit/
│   └── config.toml           # Streamlit 테마 및 서버 설정
├── .env                      # OPENAI_API_KEY (gitignore)
├── .gitignore
├── requirements.txt
└── LICENSE
```

---

## 10. 프롬프트 전략

### 적용 기법

| 기법 | 적용 위치 | 설명 |
|------|-----------|------|
| Role Prompting | SystemMessage | "엄마 같은 친구" 역할 명확히 부여 |
| Persona Setting | SystemMessage | 말투, 성격, 반응 방식(4대 원칙) 정의 |
| Few-shot Prompting | SystemMessage | 엄마 말투 예시 + 부적절한 표현 예시 제공 |
| Constraint Setting | SystemMessage | 진단 금지, 3문장 이내, 매크로 답변 금지 |
| Context Injection | SystemMessage (동적) | 등록된 병력 + 오늘의 건강일기 자동 삽입 |
| Chain of Thought | 응답 구조 | 감정 공감 → 상황 위로 → 가벼운 조언/질문 |

### 응답 구조 (3단계)

```
Step 1. 감정적 반응  — "아구", "어머", "어떡해" 등 감탄사로 공감 시작
Step 2. 상황적 위로  — 증상으로 인한 일상 불편함을 짚어줌
Step 3. 가벼운 조언/질문 — 일상 처치법 제안 또는 상태를 묻는 짧은 질문 1개
```

### 주요 제약 (prompts.py `cautions`)

- 사용자가 언급하지 않은 증상(예: 두통, 발열 등)을 임의로 넘겨짚어 지어내지 않음
- 약 봉투 사진, 상처 등을 분석할 때도 기계적인 번호 매기기나 개조식(불릿 포인트)을 쓰지 않고, 대화하듯 자연스럽게 풀어냄
- "따뜻한 물 마셔봐" 같은 매크로성 답변을 남발하지 않고, 증상에 맞는 다양한 조언 제공
- 스스로 의학적 진단을 내리거나 특정 진료과를 직접 명시하지 않음
- 병원 안내 요청 시 시스템이 지도 링크를 자동 삽입하므로 AI는 다정한 권유 멘트만 작성

### 파라미터 설정

| 파라미터 | 값 | 설정 이유 |
|----------|-----|-----------|
| model (대화) | gpt-4o-mini | 비용 효율적, 일반 대화에 충분 |
| model (이미지) | gpt-4o | Vision 기능은 더 강력한 모델 필요 |
| temperature | 0.7 | 엄마 말투의 자연스럽고 따뜻한 변화감 |
| max_tokens (이미지) | 1000 | 약 정보 설명에 충분한 분량 |
| 대화 히스토리 | 당일 전체 유지 | 맥락 유지, 날짜 바뀌면 JSON에 저장 |

---

## 11. 데이터 구조

### `medical_history.json`

```json
[
  {
    "disease": "고혈압",
    "date": "2022-03",
    "memo": "현재 약 복용 중",
    "created_at": "2024-01-15 10:30:00"
  }
]
```

### `health_diary.json`

```json
{
  "2024-03-15": {
    "condition": "😊 좋음",
    "symptoms": ["🤕 두통"],
    "bowel": "✅ 건강함",
    "sleep_hours": 7.0,
    "exercise": ["🚶 걷기"],
    "hospital": ["❌ 방문 안 함"],
    "memo": "오늘은 좀 나은 것 같다",
    "updated_at": "2024-03-15 20:00:00"
  }
}
```

### `chat_YYYY-MM-DD.json`

```json
[
  {"role": "assistant", "content": "어디 불편한 데 있어?"},
  {"role": "user", "content": "머리가 너무 아파"}
]
```

---

## 12. 설치 및 실행

```bash
git clone <repo-url>
cd Langchin
pip install -r requirements.txt
```

`.env` 파일 생성:

```
OPENAI_API_KEY=sk-...
```

앱 실행:

```bash
streamlit run app.py
```

### Streamlit Cloud 배포

1. GitHub 저장소를 Streamlit Cloud에 연결
2. **Settings → Secrets** 탭에 API 키 입력:

```toml
OPENAI_API_KEY = "sk-..."
```

> `app.py`에서 `st.secrets` fallback이 구현되어 있어, `.env` 파일이 없는 클라우드 환경에서도 Secrets 설정만으로 동작합니다.

---

## 13. 제약사항 및 향후 계획

### 현재 한계점

| 한계점 | 설명 |
|--------|------|
| 복약 알림 미작동 | UI만 존재, 실제 푸시 알림 없음 (Streamlit 백그라운드 실행 불가) |
| 단일 사용자 | 로그인/인증 없음, 데이터는 로컬 JSON 저장 |
| 개인정보 보안 | 병력 데이터가 암호화 없이 로컬 저장 |
| 할루시네이션 | 의학 정보 오류 가능성 존재 |
| API 비용 | OpenAI API 사용량에 따라 비용 발생 |

### 향후 개선 방향

| 개선 방향 | 설명 |
|-----------|------|
| 모바일 앱 전환 | FastAPI + 모바일 앱으로 전환하여 푸시 알림 지원 |
| 사용자 인증 | 암호화 DB + 로그인 인증 도입 |
| RAG 도입 | 신뢰 가능한 의학 문서 기반 답변 생성으로 할루시네이션 감소 |
| 지도 API 연동 | 카카오맵/네이버 지도 API 직접 연동으로 병원 검색 고도화 |
| 실비 청구 지원 | 보험사 API 제휴 후 OCR + API 연동 |

---

## 라이선스

[MIT License](LICENSE)
